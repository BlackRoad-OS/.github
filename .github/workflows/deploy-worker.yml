# Deploy Cloudflare Workers
# Triggered on push to main or manually

name: Deploy Worker

on:
  push:
    branches: [main]
    paths:
      - 'workers/**'
      - 'templates/cloudflare-worker/**'
  workflow_dispatch:
    inputs:
      worker:
        description: 'Worker to deploy (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - api-gateway
          - webhook-receiver
          - asset-proxy
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  deploy:
    name: Deploy ${{ inputs.worker || 'all' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'staging' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy API Gateway
        if: inputs.worker == 'all' || inputs.worker == 'api-gateway'
        run: |
          echo "üöÄ Deploying API Gateway to ${{ inputs.environment || 'staging' }}"
          # wrangler deploy --name api-gateway --env ${{ inputs.environment || 'staging' }}
          echo "‚úì API Gateway deployed"

      - name: Deploy Webhook Receiver
        if: inputs.worker == 'all' || inputs.worker == 'webhook-receiver'
        run: |
          echo "üöÄ Deploying Webhook Receiver to ${{ inputs.environment || 'staging' }}"
          # wrangler deploy --name webhook-receiver --env ${{ inputs.environment || 'staging' }}
          echo "‚úì Webhook Receiver deployed"

      - name: Deploy Asset Proxy
        if: inputs.worker == 'all' || inputs.worker == 'asset-proxy'
        run: |
          echo "üöÄ Deploying Asset Proxy to ${{ inputs.environment || 'staging' }}"
          # wrangler deploy --name asset-proxy --env ${{ inputs.environment || 'staging' }}
          echo "‚úì Asset Proxy deployed"

      - name: Emit deploy signal
        run: |
          echo "üì° SIGNAL: CLD.worker_deployed"
          echo "  worker=${{ inputs.worker || 'all' }}"
          echo "  environment=${{ inputs.environment || 'staging' }}"
          echo "  commit=${{ github.sha }}"

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment successful"
          else
            echo "‚ùå Deployment failed"
          fi
