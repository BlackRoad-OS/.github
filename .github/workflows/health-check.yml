# ═══════════════════════════════════════════════════════════════════
# Health Check — Full Mesh + Tunnel + Service Monitoring
# Probes all 4 tunnels, 30+ domains, every service endpoint
# ═══════════════════════════════════════════════════════════════════

name: Health Check

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      target:
        description: 'Target to check'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - tunnels
          - services
          - dns
          - edge

env:
  API_ENDPOINT: ${{ vars.API_ENDPOINT || 'https://api.blackroad.ai' }}

jobs:
  # ─── Edge Gateway Health ───────────────────────────────────────
  check-edge:
    name: Edge Gateway
    runs-on: ubuntu-latest
    if: inputs.target == 'all' || inputs.target == 'edge' || inputs.target == ''
    outputs:
      status: ${{ steps.edge.outputs.status }}
      latency: ${{ steps.edge.outputs.latency }}
    steps:
      - name: Check API Gateway
        id: edge
        run: |
          START=$(date +%s%N)
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 \
            "$API_ENDPOINT/health" 2>/dev/null || echo "000")
          END=$(date +%s%N)
          LATENCY=$(( (END - START) / 1000000 ))
          echo "Edge: $HTTP_CODE (${LATENCY}ms)"
          echo "latency=$LATENCY" >> $GITHUB_OUTPUT
          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: Check Auth & AI endpoints
        continue-on-error: true
        run: |
          for ep in /v1/auth/login /v1/ai/complete /v1/ai/embed; do
            CODE=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 5 \
              "$API_ENDPOINT$ep" -X POST -d '{}' -H "Content-Type: application/json" 2>/dev/null || echo "000")
            echo "  $ep: $CODE"
          done

      - name: Check Webhook receivers
        continue-on-error: true
        run: |
          for src in github stripe salesforce slack cloudflare figma google; do
            CODE=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 5 \
              "$API_ENDPOINT/v1/webhooks/$src" -X POST -d '{}' \
              -H "Content-Type: application/json" 2>/dev/null || echo "000")
            echo "  webhook/$src: $CODE"
          done

  # ─── Tunnel Health (All 4) ────────────────────────────────────
  check-tunnels:
    name: Tunnel ${{ matrix.tunnel }}
    runs-on: ubuntu-latest
    if: inputs.target == 'all' || inputs.target == 'tunnels' || inputs.target == ''
    strategy:
      fail-fast: false
      matrix:
        include:
          - tunnel: blackroad-primary
            node: lucidia
            endpoints: "api.blackroad.ai metrics.blackroad.ai auth.blackroad.ai vault.blackroad.ai inference.blackroad.ai gov.blackroad.ai"
          - tunnel: blackroad-storage
            node: aria
            endpoints: "storage.blackroad.ai gdrive.blackroad.ai backup.blackroad.ai"
          - tunnel: blackroad-agents
            node: alice
            endpoints: "agents.blackroad.ai ai.blackroad.ai mcp.blackroad.ai"
          - tunnel: blackroad-compute
            node: octavia
            endpoints: "jobs.blackroad.ai content.blackroad.ai social.blackroad.ai game.blackroad.ai figma.blackroad.ai assets.blackroad.ai lab.blackroad.ai"
    steps:
      - name: Probe tunnel endpoints
        id: check
        run: |
          HEALTHY=0
          TOTAL=0
          for domain in ${{ matrix.endpoints }}; do
            TOTAL=$((TOTAL + 1))
            CODE=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 \
              "https://${domain}/health" 2>/dev/null || echo "000")
            if [ "$CODE" = "200" ]; then
              echo "  [OK]  ${domain}"
              HEALTHY=$((HEALTHY + 1))
            else
              echo "  [$CODE] ${domain}"
            fi
          done
          echo "healthy=$HEALTHY" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

  # ─── DNS Resolution ────────────────────────────────────────────
  check-dns:
    name: DNS Resolution
    runs-on: ubuntu-latest
    if: inputs.target == 'all' || inputs.target == 'dns' || inputs.target == ''
    outputs:
      resolved: ${{ steps.dns.outputs.resolved }}
      failed: ${{ steps.dns.outputs.failed }}
    steps:
      - name: Check all 30+ domains
        id: dns
        run: |
          DOMAINS="api edge metrics auth vault inference gov ssh storage storage-console gdrive backup db redis agents ai mcp hailo-alice jobs content social game meta figma assets lab cdn learn docs prometheus"
          RESOLVED=0
          FAILED=0
          for name in $DOMAINS; do
            RESULT=$(dig +short "${name}.blackroad.ai" 2>/dev/null | head -1)
            if [ -n "$RESULT" ]; then
              echo "  [OK]  ${name}.blackroad.ai"
              RESOLVED=$((RESOLVED + 1))
            else
              echo "  [--]  ${name}.blackroad.ai"
              FAILED=$((FAILED + 1))
            fi
          done
          echo "resolved=$RESOLVED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

  # ─── External Services ─────────────────────────────────────────
  check-services:
    name: External Services
    runs-on: ubuntu-latest
    if: inputs.target == 'all' || inputs.target == 'services' || inputs.target == ''
    steps:
      - name: Check GitHub + Cloudflare + Tailscale
        run: |
          for svc in "https://api.github.com/rate_limit" "https://www.cloudflare.com/cdn-cgi/trace" "https://controlplane.tailscale.com/key"; do
            CODE=$(curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 5 "$svc" 2>/dev/null || echo "000")
            echo "$svc: $CODE"
          done

  # ─── Update Status ────────────────────────────────────────────
  update-status:
    name: Update Status
    runs-on: ubuntu-latest
    needs: [check-edge, check-tunnels, check-dns, check-services]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Write status
        run: |
          cat > .STATUS << EOF
          # BlackRoad System Status
          Last check: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          Edge: ${{ needs.check-edge.outputs.status || 'unknown' }} (${{ needs.check-edge.outputs.latency || '?' }}ms)
          DNS resolved: ${{ needs.check-dns.outputs.resolved || '?' }}
          DNS failed: ${{ needs.check-dns.outputs.failed || '?' }}
          Signal: health_check_complete
          EOF
      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .STATUS
          git diff --cached --quiet || git commit -m "Update health status"

  # ─── Alert ─────────────────────────────────────────────────────
  alert:
    name: Alert
    runs-on: ubuntu-latest
    needs: [check-edge, check-tunnels]
    if: always() && needs.check-edge.outputs.status == 'unhealthy'
    steps:
      - name: Emit alert
        run: |
          echo "ALERT: Edge gateway unhealthy"
          echo "Signal: OS → OS : health_alert, status=degraded"
      - name: Create issue
        uses: actions/github-script@v7
        with:
          script: |
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo,
              labels: 'health-alert', state: 'open',
            });
            if (existing.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title: `Health Alert: Edge unhealthy (${new Date().toISOString()})`,
                body: `Edge: ${{ needs.check-edge.outputs.status }}\nDNS failed: ${{ needs.check-dns.outputs.failed || '?' }}`,
                labels: ['health-alert', 'automated'],
              });
            }
