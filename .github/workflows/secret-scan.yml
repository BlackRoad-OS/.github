# ═══════════════════════════════════════════════════════════════════
# Secret Scanning & Credential Rotation — Detect leaked secrets,
# hardcoded keys, and enforce rotation policies
# ═══════════════════════════════════════════════════════════════════

name: Secret Scan

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  schedule:
    - cron: "0 2 * * *" # Daily 2am UTC

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  # ─── Detect hardcoded secrets ──────────────────────────────────
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --results=verified,unverified --only-verified

  # ─── Pattern-based secret detection ────────────────────────────
  gitleaks:
    name: Gitleaks Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ─── Custom pattern scan ───────────────────────────────────────
  custom-scan:
    name: Custom Secret Patterns
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan for common secret patterns
        run: |
          echo "Scanning for hardcoded secrets..."
          FOUND=0

          # AWS keys
          if grep -rn "AKIA[0-9A-Z]\{16\}" --include="*.ts" --include="*.js" --include="*.py" --include="*.yaml" --include="*.yml" --include="*.json" . 2>/dev/null | grep -v node_modules | grep -v ".git/"; then
            echo "ALERT: Possible AWS access key found"
            FOUND=1
          fi

          # Private keys
          if grep -rn "BEGIN.*PRIVATE KEY" --include="*.ts" --include="*.js" --include="*.py" --include="*.yaml" --include="*.yml" --include="*.pem" . 2>/dev/null | grep -v node_modules | grep -v ".git/"; then
            echo "ALERT: Private key found"
            FOUND=1
          fi

          # Generic API keys / tokens
          if grep -rn "sk_live_\|sk_test_\|pk_live_\|pk_test_" --include="*.ts" --include="*.js" --include="*.py" --include="*.yaml" . 2>/dev/null | grep -v node_modules | grep -v ".git/"; then
            echo "ALERT: Stripe key found"
            FOUND=1
          fi

          # Slack tokens
          if grep -rn "xoxb-\|xoxp-\|xoxs-" --include="*.ts" --include="*.js" --include="*.py" --include="*.yaml" . 2>/dev/null | grep -v node_modules | grep -v ".git/"; then
            echo "ALERT: Slack token found"
            FOUND=1
          fi

          # JWT secrets / hardcoded passwords
          if grep -rn "password\s*=\s*[\"'][^\"']\{8,\}[\"']" --include="*.ts" --include="*.js" --include="*.py" . 2>/dev/null | grep -v node_modules | grep -v ".git/" | grep -v "test\|spec\|mock\|example"; then
            echo "ALERT: Possible hardcoded password found"
            FOUND=1
          fi

          # .env files that shouldn't be committed
          if find . -name ".env" -not -name ".env.example" -not -name ".env.template" -not -path "*/node_modules/*" -not -path "*/.git/*" 2>/dev/null | head -5 | grep .; then
            echo "ALERT: .env file found in repository"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            echo "SECRET SCAN FAILED — Review findings above"
            exit 1
          fi

          echo "No secrets detected"

  # ─── Check secret rotation status ──────────────────────────────
  rotation-check:
    name: Secret Rotation Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Audit secret ages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Secret Rotation Audit — $(date -u)"
          echo "======================================"
          echo ""
          echo "Required secrets (check manually):"
          echo "  - JWT_SECRET: Rotate every 90 days"
          echo "  - GITHUB_WEBHOOK_SECRET: Rotate every 180 days"
          echo "  - STRIPE_WEBHOOK_SECRET: Rotate every 180 days"
          echo "  - ANTHROPIC_API_KEY: Rotate every 90 days"
          echo "  - CLOUDFLARE_API_TOKEN: Rotate every 90 days"
          echo "  - TAILSCALE_AUTH_KEY: Rotate every 90 days"
          echo ""
          echo "Signal: SEC → OS : secret_rotation_audit_complete"

      - name: Create rotation reminder issue
        uses: actions/github-script@v7
        with:
          script: |
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'secret-rotation',
              state: 'open',
            });
            // Only create if no open rotation issue exists
            if (existing.data.length === 0) {
              const now = new Date();
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Secret Rotation Reminder — ${now.toISOString().slice(0, 10)}`,
                body: [
                  '## Monthly Secret Rotation Check',
                  '',
                  'Review and rotate the following secrets if older than their rotation period:',
                  '',
                  '| Secret | Rotation Period | Action |',
                  '|--------|----------------|--------|',
                  '| `JWT_SECRET` | 90 days | Regenerate, update Workers |',
                  '| `GITHUB_WEBHOOK_SECRET` | 180 days | Regenerate in both GitHub and Workers |',
                  '| `STRIPE_WEBHOOK_SECRET` | 180 days | Regenerate in Stripe dashboard |',
                  '| `ANTHROPIC_API_KEY` | 90 days | Regenerate in Anthropic console |',
                  '| `CLOUDFLARE_API_TOKEN` | 90 days | Regenerate in Cloudflare dashboard |',
                  '| `TAILSCALE_AUTH_KEY` | 90 days | Regenerate in Tailscale admin |',
                  '',
                  'After rotating, update the secret in:',
                  '1. GitHub repository secrets',
                  '2. Cloudflare Workers environment',
                  '3. Any local .env files',
                  '',
                  '---',
                  '*Automated by secret-scan.yml*',
                ].join('\n'),
                labels: ['secret-rotation', 'security', 'automated'],
              });
            }
