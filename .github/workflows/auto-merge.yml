# Auto-merge PRs after CI passes
# Automatically merges approved PRs to main once all checks pass

name: Auto Merge

on:
  pull_request_review:
    types: [submitted]
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    
    # Only run on approved PRs targeting main
    if: |
      github.event_name == 'pull_request_review' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    permissions:
      contents: write
      pull-requests: write
      checks: read
    
    steps:
      - uses: actions/checkout@v4

      - name: Get PR info
        id: pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR number from the event
          if [ "${{ github.event_name }}" == "pull_request_review" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" == "workflow_run" ]; then
            # Extract PR number from workflow run
            PR_NUMBER=$(gh pr list --json number,headRefName --jq '.[] | select(.headRefName=="${{ github.event.workflow_run.head_branch }}") | .number' | head -1)
          else
            echo "No PR found for event type: ${{ github.event_name }}"
            exit 1
          fi
          
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR number found for branch ${{ github.event.workflow_run.head_branch }}"
            exit 1
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          # Get PR details
          PR_DATA=$(gh pr view $PR_NUMBER --json number,title,state,mergeable,reviewDecision,statusCheckRollup)
          
          echo "$PR_DATA" | jq .
          
          STATE=$(echo "$PR_DATA" | jq -r .state)
          MERGEABLE=$(echo "$PR_DATA" | jq -r .mergeable)
          REVIEW_DECISION=$(echo "$PR_DATA" | jq -r .reviewDecision)
          
          echo "state=$STATE" >> $GITHUB_OUTPUT
          echo "mergeable=$MERGEABLE" >> $GITHUB_OUTPUT
          echo "review_decision=$REVIEW_DECISION" >> $GITHUB_OUTPUT

      - name: Check merge conditions
        id: check
        run: |
          STATE="${{ steps.pr.outputs.state }}"
          MERGEABLE="${{ steps.pr.outputs.mergeable }}"
          REVIEW_DECISION="${{ steps.pr.outputs.review_decision }}"
          
          echo "PR State: $STATE"
          echo "Mergeable: $MERGEABLE"
          echo "Review Decision: $REVIEW_DECISION"
          
          # Check conditions
          CAN_MERGE=false
          
          if [ "$STATE" == "OPEN" ] && \
             [ "$MERGEABLE" == "MERGEABLE" ] && \
             [ "$REVIEW_DECISION" == "APPROVED" ]; then
            CAN_MERGE=true
          fi
          
          echo "can_merge=$CAN_MERGE" >> $GITHUB_OUTPUT
          
          if [ "$CAN_MERGE" == "true" ]; then
            echo "‚úì All conditions met for auto-merge"
          else
            echo "‚ö†Ô∏è  Conditions not met:"
            [ "$STATE" != "OPEN" ] && echo "  - PR is not open"
            [ "$MERGEABLE" != "MERGEABLE" ] && echo "  - PR has conflicts or is not mergeable"
            [ "$REVIEW_DECISION" != "APPROVED" ] && echo "  - PR is not approved"
          fi

      - name: Auto-merge PR
        if: steps.check.outputs.can_merge == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          
          echo "üöÄ Auto-merging PR #$PR_NUMBER to main..."
          
          # Enable auto-merge with squash
          gh pr merge $PR_NUMBER --auto --squash --delete-branch
          
          echo "‚úì Auto-merge enabled"

      - name: Comment on PR
        if: steps.check.outputs.can_merge == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          
          gh pr comment $PR_NUMBER --body "ü§ñ Auto-merge enabled. This PR will be merged automatically once all status checks pass."

      - name: Summary
        if: always()
        run: |
          echo "üéØ Auto-merge Summary"
          echo ""
          echo "PR: #${{ steps.pr.outputs.pr_number }}"
          echo "State: ${{ steps.pr.outputs.state }}"
          echo "Can merge: ${{ steps.check.outputs.can_merge }}"
          echo "Status: ${{ job.status }}"
