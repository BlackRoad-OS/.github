<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlackRoad Pets - Virtual World</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0d0d1a;display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:'Press Start 2P',monospace;overflow:hidden}
#game-wrapper{position:relative;width:800px;height:600px;border:3px solid #2a2a4a;border-radius:8px;overflow:hidden;box-shadow:0 0 40px rgba(255,107,157,0.2)}
canvas{display:block;image-rendering:pixelated}
/* TOP HUD */
#hud-top{position:absolute;top:0;left:0;width:100%;display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:linear-gradient(180deg,rgba(0,0,0,0.8),transparent);z-index:10}
#hud-top span{font-size:8px;color:#e0e0e0}
.stat-group{display:flex;align-items:center;gap:6px}
.stat-bar{width:60px;height:8px;background:#222;border-radius:4px;border:1px solid #444;overflow:hidden}
.stat-fill{height:100%;border-radius:3px;transition:width 0.4s}
.fill-happy{background:linear-gradient(90deg,#ff6b9d,#ff4081)}
.fill-hunger{background:linear-gradient(90deg,#f5a623,#ff8f00)}
.fill-energy{background:linear-gradient(90deg,#7ed321,#4caf50)}
.fill-hygiene{background:linear-gradient(90deg,#00d4ff,#0097a7)}
#coins-display{color:#f5a623!important;font-size:9px!important}
/* ROOM TABS */
#room-tabs{position:absolute;top:36px;left:50%;transform:translateX(-50%);display:flex;gap:4px;z-index:10}
.room-tab{font-family:'Press Start 2P',monospace;font-size:7px;color:#aaa;background:rgba(0,0,0,0.6);border:1px solid #2a2a4a;border-radius:4px 4px 0 0;padding:4px 10px;cursor:pointer;transition:all 0.15s}
.room-tab:hover{color:#fff;border-color:#ff6b9d}
.room-tab.active{color:#fff;background:rgba(255,107,157,0.2);border-color:#ff6b9d}
/* ACTION BAR */
#action-bar{position:absolute;bottom:0;left:0;width:100%;background:rgba(0,0,0,0.85);border-top:2px solid #ff6b9d;display:flex;justify-content:center;gap:6px;padding:8px;z-index:10}
.action-btn{font-family:'Press Start 2P',monospace;font-size:7px;color:#fff;border:2px solid #2a2a4a;border-radius:6px;padding:8px 12px;cursor:pointer;transition:all 0.15s;display:flex;flex-direction:column;align-items:center;gap:4px;min-width:70px}
.action-btn:hover{border-color:#ff6b9d;transform:scale(1.03)}
.action-btn .btn-icon{font-size:18px}
.action-btn.feed{background:linear-gradient(135deg,#e65100,#bf360c)}
.action-btn.play{background:linear-gradient(135deg,#c44dff,#9013fe)}
.action-btn.wash{background:linear-gradient(135deg,#0097a7,#006064)}
.action-btn.sleep{background:linear-gradient(135deg,#1565c0,#0d47a1)}
.action-btn.shop{background:linear-gradient(135deg,#f5a623,#e65100)}
.action-btn.decor{background:linear-gradient(135deg,#d81b60,#880e4f)}
.action-btn.mini{background:linear-gradient(135deg,#2e7d32,#1b5e20)}
/* PET SELECT */
#pet-select{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a2e;border:3px solid #ff6b9d;border-radius:12px;padding:20px;z-index:50;text-align:center;min-width:400px}
#pet-select h2{font-size:12px;color:#ff6b9d;margin-bottom:16px}
#pet-select p{font-size:7px;color:#8888aa;margin-bottom:16px}
.pet-options{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.pet-option{width:80px;height:100px;background:rgba(255,255,255,0.05);border:2px solid #2a2a4a;border-radius:8px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;transition:all 0.2s}
.pet-option:hover{border-color:#ff6b9d;transform:scale(1.05);background:rgba(255,107,157,0.1)}
.pet-option .pet-emoji{font-size:32px}
.pet-option .pet-name{font-size:6px;color:#e0e0e0}
/* SHOP MODAL */
#shop-modal{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a2e;border:3px solid #f5a623;border-radius:12px;padding:16px;z-index:40;display:none;min-width:350px;max-height:400px;overflow-y:auto}
#shop-modal h3{font-size:10px;color:#f5a623;margin-bottom:12px;text-align:center}
.shop-category{font-size:8px;color:#ff6b9d;margin:8px 0 4px}
.shop-row{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;background:rgba(255,255,255,0.03);border-radius:4px;margin-bottom:3px;cursor:pointer;transition:background 0.15s}
.shop-row:hover{background:rgba(245,166,35,0.15)}
.shop-row span{font-size:8px;color:#e0e0e0}
.shop-row .s-price{color:#f5a623}
.close-btn{font-family:'Press Start 2P',monospace;font-size:7px;color:#ff6b9d;background:none;border:1px solid #ff6b9d;padding:4px 12px;border-radius:4px;cursor:pointer;display:block;margin:8px auto 0}
/* MINIGAME */
#minigame-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;z-index:45;flex-direction:column;align-items:center;justify-content:center}
#minigame-overlay h3{font-size:10px;color:#7ed321;margin-bottom:16px}
#minigame-overlay p{font-size:7px;color:#aaa;margin-bottom:8px}
#mini-canvas{border:2px solid #2a2a4a;border-radius:4px}
#mini-score{font-size:9px;color:#f5a623;margin-top:8px}
#mini-close{font-family:'Press Start 2P',monospace;font-size:8px;color:#fff;background:#d32f2f;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin-top:12px}
/* MSG */
#msg{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);border:2px solid #c44dff;border-radius:6px;padding:8px 16px;font-size:8px;color:#e0e0e0;display:none;z-index:15;text-align:center;max-width:400px}
</style>
</head>
<body>
<div id="game-wrapper">
  <canvas id="game" width="800" height="600"></canvas>
  <div id="hud-top">
    <div class="stat-group"><span>HAPPY</span><div class="stat-bar"><div class="stat-fill fill-happy" id="bar-happy" style="width:80%"></div></div></div>
    <div class="stat-group"><span>HUNGER</span><div class="stat-bar"><div class="stat-fill fill-hunger" id="bar-hunger" style="width:70%"></div></div></div>
    <div class="stat-group"><span>ENERGY</span><div class="stat-bar"><div class="stat-fill fill-energy" id="bar-energy" style="width:100%"></div></div></div>
    <div class="stat-group"><span>CLEAN</span><div class="stat-bar"><div class="stat-fill fill-hygiene" id="bar-hygiene" style="width:90%"></div></div></div>
    <span id="coins-display">1000 KinzCoins</span>
  </div>
  <div id="room-tabs">
    <button class="room-tab active" data-room="bedroom">Bedroom</button>
    <button class="room-tab" data-room="kitchen">Kitchen</button>
    <button class="room-tab" data-room="yard">Yard</button>
    <button class="room-tab" data-room="arcade">Arcade</button>
    <button class="room-tab" data-room="spa">Spa</button>
  </div>
  <div id="action-bar">
    <button class="action-btn feed" onclick="feedPet()"><span class="btn-icon">\uD83C\uDF54</span>Feed</button>
    <button class="action-btn play" onclick="playWithPet()"><span class="btn-icon">\u26BD</span>Play</button>
    <button class="action-btn wash" onclick="washPet()"><span class="btn-icon">\uD83D\uDEC1</span>Wash</button>
    <button class="action-btn sleep" onclick="sleepPet()"><span class="btn-icon">\uD83D\uDCA4</span>Sleep</button>
    <button class="action-btn shop" onclick="toggleShop()"><span class="btn-icon">\uD83D\uDED2</span>Shop</button>
    <button class="action-btn decor" onclick="placeDecor()"><span class="btn-icon">\uD83C\uDFA8</span>Decor</button>
    <button class="action-btn mini" onclick="startMinigame()"><span class="btn-icon">\uD83C\uDFAE</span>Games</button>
  </div>
  <div id="msg"></div>

  <div id="shop-modal">
    <h3>BLACKROAD PET SHOP</h3>
    <div id="shop-content"></div>
    <button class="close-btn" onclick="toggleShop()">CLOSE</button>
  </div>

  <div id="minigame-overlay">
    <h3>CATCH THE TREATS!</h3>
    <p>Use LEFT/RIGHT arrows to catch falling treats</p>
    <canvas id="mini-canvas" width="400" height="300"></canvas>
    <div id="mini-score">Score: 0</div>
    <button id="mini-close" onclick="endMinigame()">DONE</button>
  </div>

  <div id="pet-select">
    <h2>CHOOSE YOUR PET</h2>
    <p>Pick your first BlackRoad companion!</p>
    <div class="pet-options">
      <div class="pet-option" onclick="choosePet(0)"><span class="pet-emoji">\uD83D\uDC31</span><span class="pet-name">Neon Cat</span></div>
      <div class="pet-option" onclick="choosePet(1)"><span class="pet-emoji">\uD83D\uDC36</span><span class="pet-name">Cyber Pup</span></div>
      <div class="pet-option" onclick="choosePet(2)"><span class="pet-emoji">\uD83D\uDC30</span><span class="pet-name">Pixel Bunny</span></div>
      <div class="pet-option" onclick="choosePet(3)"><span class="pet-emoji">\uD83E\uDD89</span><span class="pet-name">Code Owl</span></div>
      <div class="pet-option" onclick="choosePet(4)"><span class="pet-emoji">\uD83D\uDC32</span><span class="pet-name">Data Dragon</span></div>
      <div class="pet-option" onclick="choosePet(5)"><span class="pet-emoji">\uD83E\uDD8A</span><span class="pet-name">Glitch Fox</span></div>
    </div>
  </div>
</div>

<script>
const canvas=document.getElementById('game');const ctx=canvas.getContext('2d');
const W=800,H=600;

const petTypes=[
  {name:'Neon Cat',icon:'\uD83D\uDC31',color:'#ff6b9d',bodyColor:'#ff8a80'},
  {name:'Cyber Pup',icon:'\uD83D\uDC36',color:'#f5a623',bodyColor:'#ffcc80'},
  {name:'Pixel Bunny',icon:'\uD83D\uDC30',color:'#c44dff',bodyColor:'#ce93d8'},
  {name:'Code Owl',icon:'\uD83E\uDD89',color:'#4a90d9',bodyColor:'#90caf9'},
  {name:'Data Dragon',icon:'\uD83D\uDC32',color:'#7ed321',bodyColor:'#a5d6a7'},
  {name:'Glitch Fox',icon:'\uD83E\uDD8A',color:'#00d4ff',bodyColor:'#80deea'}
];

// Game state
let pet=null;
let stats={happy:80,hunger:70,energy:100,hygiene:90};
let coins=1000;
let currentRoom='bedroom';
let roomItems={bedroom:[],kitchen:[],yard:[],arcade:[],spa:[]};
let ownedFood=[];
let ownedDecor=[];
let petX=400,petY=320,petVx=0,petVy=0,petState='idle',petAnimFrame=0;
let particles=[];
let floatingTexts=[];

// Shop data
const shopData={
  food:[
    {name:'Kibble',icon:'\uD83C\uDF5A',price:20,hunger:15,happy:5},
    {name:'Burger',icon:'\uD83C\uDF54',price:50,hunger:30,happy:10},
    {name:'Pizza',icon:'\uD83C\uDF55',price:60,hunger:35,happy:15},
    {name:'Sushi',icon:'\uD83C\uDF63',price:80,hunger:25,happy:20},
    {name:'Cake',icon:'\uD83C\uDF82',price:100,hunger:20,happy:30},
    {name:'Ice Cream',icon:'\uD83C\uDF66',price:40,hunger:15,happy:20},
  ],
  decor:[
    {name:'Pixel Lamp',icon:'\uD83D\uDCA1',price:150,happy:5},
    {name:'Neon Sign',icon:'\u2728',price:200,happy:8},
    {name:'Plush Toy',icon:'\uD83E\uDDF8',price:120,happy:10},
    {name:'Plant',icon:'\uD83C\uDF3F',price:80,happy:3},
    {name:'Poster',icon:'\uD83D\uDDBC',price:100,happy:5},
    {name:'Rug',icon:'\uD83E\uDEA8',price:180,happy:7},
    {name:'Bookshelf',icon:'\uD83D\uDCDA',price:250,happy:12},
    {name:'Aquarium',icon:'\uD83D\uDC20',price:300,happy:15},
  ],
  toys:[
    {name:'Ball',icon:'\u26BD',price:60,happy:15},
    {name:'Frisbee',icon:'\uD83E\uDD4F',price:80,happy:18},
    {name:'Bone',icon:'\uD83E\uDDB4',price:40,happy:10},
  ]
};

function choosePet(idx){
  pet=petTypes[idx];
  document.getElementById('pet-select').style.display='none';
  showMsg(`Welcome, ${pet.name}! Take great care of your new friend!`);
}

// --- ROOM RENDERING ---
const roomBGs={
  bedroom:{floor:'#4a3728',wall:'#6d4c41',accent:'#ff6b9d',items:[
    {type:'bed',x:100,y:280},{type:'window',x:400,y:100},{type:'rug',x:350,y:380}
  ]},
  kitchen:{floor:'#e0c8a0',wall:'#fff9c4',accent:'#f5a623',items:[
    {type:'fridge',x:80,y:180},{type:'stove',x:200,y:200},{type:'table',x:450,y:300}
  ]},
  yard:{floor:'#4caf50',wall:'#87CEEB',accent:'#7ed321',items:[
    {type:'tree',x:650,y:150},{type:'flowers',x:200,y:400},{type:'pond',x:500,y:350}
  ]},
  arcade:{floor:'#1a1a2e',wall:'#0d0d1a',accent:'#c44dff',items:[
    {type:'machine',x:150,y:200},{type:'machine',x:350,y:200},{type:'machine',x:550,y:200}
  ]},
  spa:{floor:'#e0f7fa',wall:'#b2ebf2',accent:'#00d4ff',items:[
    {type:'tub',x:400,y:300},{type:'plant',x:100,y:200},{type:'plant',x:650,y:200}
  ]}
};

function drawRoom(){
  const room=roomBGs[currentRoom];
  // Wall
  const wgrd=ctx.createLinearGradient(0,0,0,H*0.45);
  wgrd.addColorStop(0,room.wall);wgrd.addColorStop(1,adjustColor(room.wall,-20));
  ctx.fillStyle=wgrd;ctx.fillRect(0,50,W,H*0.4);

  // Floor
  ctx.fillStyle=room.floor;ctx.fillRect(0,H*0.45+50,W,H*0.55);
  // Floor pattern
  ctx.fillStyle='rgba(0,0,0,0.05)';
  for(let r=0;r<10;r++) for(let c=0;c<16;c++){
    if((r+c)%2===0) ctx.fillRect(c*50,H*0.45+50+r*30,50,30);
  }

  // Baseboard
  ctx.fillStyle=adjustColor(room.floor,-30);
  ctx.fillRect(0,H*0.45+46,W,8);

  // Room furniture
  room.items.forEach(item=>drawFurniture(item,room));

  // Placed decor items
  (roomItems[currentRoom]||[]).forEach(d=>{
    ctx.font='28px serif';ctx.textAlign='center';
    ctx.fillText(d.icon,d.x,d.y);
    ctx.textAlign='left';
  });
}

function drawFurniture(item,room){
  const x=item.x,y=item.y;
  switch(item.type){
    case 'bed':
      ctx.fillStyle='#5d4037';ctx.fillRect(x,y,140,80);
      ctx.fillStyle=room.accent;ctx.fillRect(x+5,y+5,130,50);
      ctx.fillStyle=adjustColor(room.accent,-20);ctx.fillRect(x+5,y+5,130,15);
      ctx.fillStyle='#fff';ctx.fillRect(x+10,y+10,40,20);ctx.fillRect(x+90,y+10,40,20);
      break;
    case 'window':
      ctx.fillStyle='#fff';ctx.fillRect(x,y,120,100);
      ctx.fillStyle='#87CEEB';ctx.fillRect(x+8,y+8,104,84);
      ctx.fillStyle='#fff';ctx.fillRect(x+58,y,4,100);ctx.fillRect(x,y+48,120,4);
      ctx.fillStyle='#FFD700';ctx.beginPath();ctx.arc(x+80,y+30,10,0,Math.PI*2);ctx.fill();
      break;
    case 'rug':
      ctx.fillStyle=room.accent;ctx.globalAlpha=0.3;
      ctx.beginPath();ctx.ellipse(x,y,80,40,0,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=1;break;
    case 'fridge':
      ctx.fillStyle='#e0e0e0';ctx.fillRect(x,y,60,140);
      ctx.fillStyle='#bdbdbd';ctx.fillRect(x,y,60,70);
      ctx.fillStyle='#9e9e9e';ctx.fillRect(x+48,y+30,4,12);ctx.fillRect(x+48,y+90,4,12);
      break;
    case 'stove':
      ctx.fillStyle='#424242';ctx.fillRect(x,y,80,100);
      ctx.fillStyle='#616161';ctx.fillRect(x+5,y+5,70,30);
      ctx.fillStyle='#212121';
      ctx.beginPath();ctx.arc(x+25,y+60,8,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(x+55,y+60,8,0,Math.PI*2);ctx.fill();
      break;
    case 'table':
      ctx.fillStyle='#8d6e63';ctx.fillRect(x,y,120,60);
      ctx.fillStyle='#795548';ctx.fillRect(x+5,y+60,10,30);ctx.fillRect(x+105,y+60,10,30);
      break;
    case 'tree':
      ctx.fillStyle='#5d4037';ctx.fillRect(x+20,y+60,16,60);
      ctx.fillStyle='#2e7d32';ctx.beginPath();ctx.arc(x+28,y+40,35,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#388e3c';ctx.beginPath();ctx.arc(x+20,y+50,25,0,Math.PI*2);ctx.fill();
      break;
    case 'flowers':
      for(let i=0;i<6;i++){
        ctx.fillStyle=['#ff6b9d','#f5a623','#c44dff','#ff4081','#ffeb3b','#e91e63'][i];
        ctx.beginPath();ctx.arc(x+i*30,y+Math.sin(i)*10,8,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#4caf50';ctx.fillRect(x+i*30-1,y+Math.sin(i)*10+5,2,15);
      }
      break;
    case 'pond':
      ctx.fillStyle='#1976d2';ctx.beginPath();ctx.ellipse(x,y,60,30,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.2)';
      ctx.beginPath();ctx.ellipse(x-10,y-5,20,8,0.3,0,Math.PI*2);ctx.fill();
      break;
    case 'machine':
      ctx.fillStyle='#1a1a2e';ctx.fillRect(x,y,80,120);
      ctx.fillStyle='#0d0d1a';ctx.fillRect(x+5,y+5,70,60);
      ctx.fillStyle=room.accent;
      ctx.fillRect(x+10,y+10,60,50);
      ctx.globalAlpha=0.5+Math.sin(Date.now()/500+item.x)*0.3;
      ctx.fillRect(x+10,y+10,60,50);
      ctx.globalAlpha=1;
      ctx.fillStyle='#333';ctx.fillRect(x+15,y+75,50,15);
      ctx.fillStyle='#f44336';ctx.beginPath();ctx.arc(x+40,y+105,6,0,Math.PI*2);ctx.fill();
      break;
    case 'tub':
      ctx.fillStyle='#fff';ctx.beginPath();ctx.ellipse(x,y,100,50,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#e0f7fa';ctx.beginPath();ctx.ellipse(x,y-5,90,40,0,0,Math.PI*2);ctx.fill();
      // Bubbles
      ctx.fillStyle='rgba(255,255,255,0.6)';
      for(let i=0;i<5;i++){
        const bx=x-40+i*20+Math.sin(Date.now()/600+i)*5;
        const by=y-15+Math.cos(Date.now()/500+i)*8;
        ctx.beginPath();ctx.arc(bx,by,4+Math.sin(Date.now()/400+i)*2,0,Math.PI*2);ctx.fill();
      }
      break;
    case 'plant':
      ctx.fillStyle='#795548';ctx.fillRect(x-10,y+20,20,25);
      ctx.fillStyle='#4caf50';
      ctx.beginPath();ctx.arc(x,y+10,15,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#66bb6a';
      ctx.beginPath();ctx.arc(x-5,y+15,10,0,Math.PI*2);ctx.fill();
      break;
  }
}

// --- PET RENDERING ---
function drawPet(){
  if(!pet)return;
  const x=petX,y=petY;
  const bounce=Math.sin(Date.now()/300)*3;
  const t=Date.now()/1000;

  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.15)';
  ctx.beginPath();ctx.ellipse(x,y+40,25,8,0,0,Math.PI*2);ctx.fill();

  // Body
  ctx.fillStyle=pet.bodyColor;
  ctx.beginPath();ctx.ellipse(x,y+10+bounce,22,28,0,0,Math.PI*2);ctx.fill();

  // Head
  ctx.fillStyle=pet.bodyColor;
  ctx.beginPath();ctx.arc(x,y-18+bounce,18,0,Math.PI*2);ctx.fill();

  // Eyes
  const blink=Math.sin(t*2)>0.95;
  ctx.fillStyle='#1a1a2e';
  if(!blink){
    ctx.beginPath();ctx.arc(x-7,y-20+bounce,3,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(x+7,y-20+bounce,3,0,Math.PI*2);ctx.fill();
    // Eye shine
    ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(x-6,y-21+bounce,1.5,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(x+8,y-21+bounce,1.5,0,Math.PI*2);ctx.fill();
  }else{
    ctx.fillRect(x-9,y-20+bounce,6,2);ctx.fillRect(x+4,y-20+bounce,6,2);
  }

  // Mouth
  if(petState==='eating'){
    ctx.fillStyle='#d32f2f';ctx.beginPath();ctx.arc(x,y-12+bounce,4,0,Math.PI);ctx.fill();
  }else if(stats.happy>60){
    ctx.strokeStyle='#5d4037';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.arc(x,y-14+bounce,5,0.1*Math.PI,0.9*Math.PI);ctx.stroke();
  }else{
    ctx.strokeStyle='#5d4037';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.arc(x,y-10+bounce,5,1.1*Math.PI,1.9*Math.PI);ctx.stroke();
  }

  // Cheeks (blush)
  if(stats.happy>70){
    ctx.fillStyle='rgba(255,107,157,0.3)';
    ctx.beginPath();ctx.arc(x-14,y-15+bounce,5,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(x+14,y-15+bounce,5,0,Math.PI*2);ctx.fill();
  }

  // Ears/features based on pet type
  const idx=petTypes.indexOf(pet);
  ctx.fillStyle=pet.color;
  if(idx===0){// cat ears
    ctx.beginPath();ctx.moveTo(x-14,y-32+bounce);ctx.lineTo(x-8,y-40+bounce);ctx.lineTo(x-2,y-32+bounce);ctx.fill();
    ctx.beginPath();ctx.moveTo(x+2,y-32+bounce);ctx.lineTo(x+8,y-40+bounce);ctx.lineTo(x+14,y-32+bounce);ctx.fill();
  }else if(idx===1){// floppy ears
    ctx.beginPath();ctx.ellipse(x-16,y-16+bounce,6,14,0.3,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(x+16,y-16+bounce,6,14,-0.3,0,Math.PI*2);ctx.fill();
  }else if(idx===2){// bunny ears
    ctx.beginPath();ctx.ellipse(x-8,y-42+bounce,5,16,0.2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(x+8,y-42+bounce,5,16,-0.2,0,Math.PI*2);ctx.fill();
  }else if(idx===3){// owl tufts
    ctx.beginPath();ctx.moveTo(x-12,y-34+bounce);ctx.lineTo(x-6,y-44+bounce);ctx.lineTo(x,y-34+bounce);ctx.fill();
    ctx.beginPath();ctx.moveTo(x,y-34+bounce);ctx.lineTo(x+6,y-44+bounce);ctx.lineTo(x+12,y-34+bounce);ctx.fill();
  }else if(idx===4){// dragon horns
    ctx.fillRect(x-10,y-38+bounce,4,12);ctx.fillRect(x+6,y-38+bounce,4,12);
  }else if(idx===5){// fox ears + tail
    ctx.beginPath();ctx.moveTo(x-16,y-30+bounce);ctx.lineTo(x-10,y-42+bounce);ctx.lineTo(x-4,y-30+bounce);ctx.fill();
    ctx.beginPath();ctx.moveTo(x+4,y-30+bounce);ctx.lineTo(x+10,y-42+bounce);ctx.lineTo(x+16,y-30+bounce);ctx.fill();
    // Tail
    ctx.beginPath();
    ctx.moveTo(x+20,y+20+bounce);
    ctx.quadraticCurveTo(x+45,y+bounce,x+35,y-10+bounce);
    ctx.lineWidth=6;ctx.strokeStyle=pet.color;ctx.stroke();
    ctx.lineWidth=1;
  }

  // Activity state icons
  if(petState==='sleeping'){
    ctx.font='16px serif';ctx.fillText('\uD83D\uDCA4',x+20,y-30+Math.sin(t)*5);
    ctx.font='12px serif';ctx.fillText('\uD83D\uDCA4',x+30,y-40+Math.sin(t+1)*5);
  }else if(petState==='playing'){
    ctx.font='14px serif';
    ctx.fillText('\u2B50',x+20+Math.sin(t*3)*8,y-30+Math.cos(t*3)*8);
    ctx.fillText('\u2728',x-25+Math.cos(t*3)*8,y-25+Math.sin(t*3)*8);
  }else if(petState==='washing'){
    ctx.fillStyle='rgba(255,255,255,0.5)';
    for(let i=0;i<4;i++){
      ctx.beginPath();ctx.arc(x-15+i*10+Math.sin(t*2+i)*5,y-5+Math.cos(t*2+i)*8,3,0,Math.PI*2);ctx.fill();
    }
  }
}

// --- PET AI MOVEMENT ---
function updatePet(){
  if(!pet||petState!=='idle')return;
  // Random wandering
  if(Math.random()<0.01){
    petVx=(Math.random()-0.5)*2;
    petVy=(Math.random()-0.5)*1;
  }
  if(Math.random()<0.02){petVx=0;petVy=0;}

  petX+=petVx;petY+=petVy;
  petX=Math.max(60,Math.min(W-60,petX));
  petY=Math.max(180,Math.min(480,petY));
}

// --- ACTIONS ---
function feedPet(){
  if(!pet)return;
  if(stats.hunger>=95){showMsg("Your pet isn't hungry!");return;}
  const food=ownedFood.pop();
  if(food){
    stats.hunger=Math.min(100,stats.hunger+food.hunger);
    stats.happy=Math.min(100,stats.happy+food.happy);
    petState='eating';
    addParticle(petX,petY-20,food.icon);
    showMsg(`${pet.name} ate ${food.name}! Yummy!`);
    setTimeout(()=>{petState='idle';},2000);
  }else{
    // Default kibble costs coins
    if(coins>=10){
      coins-=10;stats.hunger=Math.min(100,stats.hunger+10);stats.happy=Math.min(100,stats.happy+3);
      petState='eating';
      addParticle(petX,petY-20,'\uD83C\uDF5A');
      showMsg('Fed basic kibble! (-10 coins)');
      setTimeout(()=>{petState='idle';},2000);
    }else{showMsg('No food! Buy some at the shop!');}
  }
  updateHUD();
}

function playWithPet(){
  if(!pet)return;
  if(stats.energy<10){showMsg(`${pet.name} is too tired to play!`);return;}
  stats.happy=Math.min(100,stats.happy+15);
  stats.energy=Math.max(0,stats.energy-10);
  stats.hunger=Math.max(0,stats.hunger-5);
  petState='playing';
  showMsg(`${pet.name} is having fun!`);
  setTimeout(()=>{petState='idle';},3000);
  updateHUD();
}

function washPet(){
  if(!pet)return;
  stats.hygiene=Math.min(100,stats.hygiene+30);
  stats.happy=Math.min(100,stats.happy+5);
  petState='washing';
  currentRoom='spa';
  updateRoomTabs();
  showMsg(`${pet.name} is getting squeaky clean!`);
  setTimeout(()=>{petState='idle';},3000);
  updateHUD();
}

function sleepPet(){
  if(!pet)return;
  if(stats.energy>=95){showMsg(`${pet.name} isn't sleepy!`);return;}
  stats.energy=Math.min(100,stats.energy+40);
  stats.happy=Math.min(100,stats.happy+5);
  petState='sleeping';
  currentRoom='bedroom';
  updateRoomTabs();
  showMsg(`${pet.name} is taking a nap... Zzz`);
  setTimeout(()=>{petState='idle';showMsg(`${pet.name} woke up refreshed!`);},4000);
  updateHUD();
}

function toggleShop(){
  const modal=document.getElementById('shop-modal');
  if(modal.style.display==='block'){modal.style.display='none';return;}
  modal.style.display='block';
  const content=document.getElementById('shop-content');
  content.innerHTML='';
  // Food
  content.innerHTML+='<div class="shop-category">FOOD</div>';
  shopData.food.forEach(f=>{
    const row=document.createElement('div');row.className='shop-row';
    row.innerHTML=`<span>${f.icon} ${f.name}</span><span class="s-price">${f.price} coins</span>`;
    row.onclick=()=>buyShopItem(f,'food');
    content.appendChild(row);
  });
  // Decor
  content.innerHTML+='<div class="shop-category">DECOR</div>';
  shopData.decor.forEach(d=>{
    const row=document.createElement('div');row.className='shop-row';
    row.innerHTML=`<span>${d.icon} ${d.name}</span><span class="s-price">${d.price} coins</span>`;
    row.onclick=()=>buyShopItem(d,'decor');
    content.appendChild(row);
  });
  // Toys
  content.innerHTML+='<div class="shop-category">TOYS</div>';
  shopData.toys.forEach(t=>{
    const row=document.createElement('div');row.className='shop-row';
    row.innerHTML=`<span>${t.icon} ${t.name}</span><span class="s-price">${t.price} coins</span>`;
    row.onclick=()=>buyShopItem(t,'toy');
    content.appendChild(row);
  });
}

function buyShopItem(item,type){
  if(coins<item.price){showMsg('Not enough coins!');return;}
  coins-=item.price;
  if(type==='food') ownedFood.push(item);
  else if(type==='decor') ownedDecor.push(item);
  else stats.happy=Math.min(100,stats.happy+(item.happy||10));
  showMsg(`Bought ${item.name}!`);
  updateHUD();
}

function placeDecor(){
  if(ownedDecor.length===0){showMsg('No decor to place! Buy some at the shop.');return;}
  const item=ownedDecor.pop();
  const x=100+Math.random()*600;
  const y=250+Math.random()*200;
  roomItems[currentRoom].push({icon:item.icon,x,y});
  stats.happy=Math.min(100,stats.happy+(item.happy||5));
  showMsg(`Placed ${item.name} in ${currentRoom}!`);
  updateHUD();
}

// --- MINIGAME ---
let miniActive=false,miniScore=0,miniBasket=200,miniTreats=[];
function startMinigame(){
  if(!pet)return;
  miniActive=true;miniScore=0;miniBasket=200;miniTreats=[];
  document.getElementById('minigame-overlay').style.display='flex';
  currentRoom='arcade';updateRoomTabs();
  miniLoop();
}
function endMinigame(){
  miniActive=false;
  document.getElementById('minigame-overlay').style.display='none';
  coins+=miniScore*5;
  stats.happy=Math.min(100,stats.happy+Math.floor(miniScore/2));
  showMsg(`Great game! Earned ${miniScore*5} coins!`);
  updateHUD();
}
function miniLoop(){
  if(!miniActive)return;
  const mc=document.getElementById('mini-canvas');
  const mctx=mc.getContext('2d');
  mctx.fillStyle='#1a1a2e';mctx.fillRect(0,0,400,300);

  // Spawn treats
  if(Math.random()<0.04) miniTreats.push({x:Math.random()*360+20,y:-10,icon:['\uD83C\uDF54','\uD83C\uDF53','\u2B50','\uD83C\uDF5A'][Math.floor(Math.random()*4)]});

  // Move treats
  miniTreats.forEach(t=>{t.y+=2.5;});
  // Catch
  miniTreats=miniTreats.filter(t=>{
    if(t.y>270&&Math.abs(t.x-miniBasket)<30){miniScore++;return false;}
    if(t.y>310)return false;
    return true;
  });

  // Draw
  miniTreats.forEach(t=>{mctx.font='20px serif';mctx.textAlign='center';mctx.fillText(t.icon,t.x,t.y);});
  // Basket
  mctx.fillStyle='#795548';mctx.fillRect(miniBasket-25,280,50,20);
  mctx.fillStyle='#8d6e63';mctx.fillRect(miniBasket-20,275,40,10);
  mctx.textAlign='left';

  document.getElementById('mini-score').textContent=`Score: ${miniScore} | Coins: +${miniScore*5}`;
  requestAnimationFrame(miniLoop);
}

// --- PARTICLES & EFFECTS ---
function addParticle(x,y,icon){
  for(let i=0;i<5;i++){
    particles.push({x,y:y-i*10,vx:(Math.random()-0.5)*3,vy:-Math.random()*3-1,life:60,icon});
  }
}

function addFloatText(x,y,text,color){
  floatingTexts.push({x,y,text,color,life:60});
}

function updateParticles(){
  particles=particles.filter(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.05;p.life--;
    ctx.globalAlpha=p.life/60;
    ctx.font='14px serif';ctx.fillText(p.icon,p.x,p.y);
    ctx.globalAlpha=1;
    return p.life>0;
  });
  floatingTexts=floatingTexts.filter(f=>{
    f.y-=1;f.life--;
    ctx.globalAlpha=f.life/60;
    ctx.fillStyle=f.color;ctx.font='8px "Press Start 2P"';
    ctx.textAlign='center';ctx.fillText(f.text,f.x,f.y);ctx.textAlign='left';
    ctx.globalAlpha=1;
    return f.life>0;
  });
}

// --- STAT DECAY ---
let decayTimer=0;
function decayStats(){
  decayTimer++;
  if(decayTimer%180===0){ // every ~3 seconds
    stats.hunger=Math.max(0,stats.hunger-1);
    stats.energy=Math.max(0,stats.energy-0.5);
    stats.hygiene=Math.max(0,stats.hygiene-0.5);
    if(stats.hunger<20) stats.happy=Math.max(0,stats.happy-2);
    if(stats.energy<20) stats.happy=Math.max(0,stats.happy-1);
    if(stats.hygiene<20) stats.happy=Math.max(0,stats.happy-1);
    updateHUD();
  }
}

// --- HUD ---
function updateHUD(){
  document.getElementById('bar-happy').style.width=stats.happy+'%';
  document.getElementById('bar-hunger').style.width=stats.hunger+'%';
  document.getElementById('bar-energy').style.width=stats.energy+'%';
  document.getElementById('bar-hygiene').style.width=stats.hygiene+'%';
  document.getElementById('coins-display').textContent=`${coins} KinzCoins`;
}

function updateRoomTabs(){
  document.querySelectorAll('.room-tab').forEach(t=>{
    t.classList.toggle('active',t.dataset.room===currentRoom);
  });
}

// Room tab clicks
document.querySelectorAll('.room-tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    currentRoom=tab.dataset.room;
    updateRoomTabs();
  });
});

let msgTimer=0;
function showMsg(text){
  const box=document.getElementById('msg');
  box.textContent=text;box.style.display='block';
  msgTimer=180;
}

function adjustColor(hex,amt){
  let r=parseInt(hex.slice(1,3),16)+amt;
  let g=parseInt(hex.slice(3,5),16)+amt;
  let b=parseInt(hex.slice(5,7),16)+amt;
  r=Math.max(0,Math.min(255,r));g=Math.max(0,Math.min(255,g));b=Math.max(0,Math.min(255,b));
  return`#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}

// --- MAIN LOOP ---
function gameLoop(){
  ctx.clearRect(0,0,W,H);
  drawRoom();
  updatePet();
  drawPet();
  updateParticles();
  decayStats();
  if(msgTimer>0){msgTimer--;if(msgTimer===0)document.getElementById('msg').style.display='none';}
  requestAnimationFrame(gameLoop);
}

// --- INPUT ---
document.addEventListener('keydown',e=>{
  if(miniActive){
    if(e.key==='ArrowLeft') miniBasket=Math.max(25,miniBasket-15);
    if(e.key==='ArrowRight') miniBasket=Math.min(375,miniBasket+15);
    e.preventDefault();
  }
});

gameLoop();
</script>
</body>
</html>
